<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Clarity Interview</title>
  <style>
    body{margin:0;padding:16px;background:#0b0c10;color:#e5e7eb;font:14px system-ui,Segoe UI,Roboto}
    .row{display:flex;gap:10px;align-items:center}
    .bar{height:6px;background:#222;border-radius:6px;overflow:hidden}
    .bar>i{display:block;height:100%;width:0;background:#4f46e5}
    video{width:100%;max-width:300px;background:#000;border-radius:8px}
    audio{width:100%}
    .badge{padding:2px 6px;border-radius:6px;font-size:12px;background:#111;border:1px solid #333}
    .log{font-family:monospace;font-size:12px;max-height:180px;overflow:auto;background:#111;padding:8px;border-radius:6px}
  </style>
</head>
<body>
  <div class="row">
    <button id="btnStart">Interview starten</button>
    <button id="btnStop">Beenden</button>
    <div id="status" class="badge">Idle</div>
  </div>

  <div class="row" style="margin-top:10px">
    <video id="localVideo" autoplay playsinline muted></video>
    <audio id="remoteAudio" controls></audio>
  </div>
  <div class="muted">Mic-Level</div>
  <div class="bar"><i id="micLevel"></i></div>

  <div style="margin-top:10px">
    <div class="badge" id="recState">rec: idle</div>
    <div class="badge" id="uploadState">upload: -</div>
  </div>

  <div id="log" class="log"></div>

<script>
const Q = new URLSearchParams(location.search);
const UID = Q.get('uid')||'test';
const COMPANY_ID = Q.get('companyId')||'demo';
const LANG = (Q.get('lang')||'de').toLowerCase();
const VOICE = (Q.get('voice')||'verse').toLowerCase();

const $status=document.getElementById('status');
const $log=document.getElementById('log');
const $localV=document.getElementById('localVideo');
const $remoteA=document.getElementById('remoteAudio');
const $mic=document.getElementById('micLevel');
const $recState=document.getElementById('recState');
const $uploadState=document.getElementById('uploadState');

let pc,DC,localStream,remoteStream,mediaRecorder;
function log(...a){console.log(...a);$log.textContent+=a.join(' ')+"\n";$log.scrollTop=$log.scrollHeight;}

async function blobToBase64(blob){
  const ab=await blob.arrayBuffer();
  let s='',bytes=new Uint8Array(ab);
  for(let i=0;i<bytes.length;i++) s+=String.fromCharCode(bytes[i]);
  return btoa(s);
}
async function uploadToWixMedia(blob){
  const base64=await blobToBase64(blob);
  const res=await fetch('/_functions/uploadToWixMedia',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({uid:UID,mime:'video/webm',filename:`${UID}.webm`,base64})
  });
  return res.json();
}

async function setupLocalMedia(){
  localStream=await navigator.mediaDevices.getUserMedia({audio:true,video:true});
  $localV.srcObject=localStream;
  // Mic-Bar
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const src=ctx.createMediaStreamSource(localStream);
  const analyser=ctx.createAnalyser();src.connect(analyser);
  const buf=new Uint8Array(analyser.frequencyBinCount);
  (function loop(){
    analyser.getByteTimeDomainData(buf);
    let dev=0;for(let i=0;i<buf.length;i++) dev=Math.max(dev,Math.abs(buf[i]-128));
    $mic.style.width=Math.min(100,dev*2)+'%';
    requestAnimationFrame(loop);
  })();
}

function startRecording(){
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const dest=ctx.createMediaStreamDestination();
  ctx.createMediaStreamSource(localStream).connect(dest);
  if(remoteStream){ctx.createMediaStreamSource(remoteStream).connect(dest);}
  const mixed=new MediaStream([...dest.stream.getTracks(),...localStream.getVideoTracks()]);
  mediaRecorder=new MediaRecorder(mixed,{mimeType:'video/webm;codecs=vp8,opus'});
  const chunks=[];
  mediaRecorder.onstart=()=>{$recState.textContent='rec: running';};
  mediaRecorder.ondataavailable=e=>{if(e.data.size>0)chunks.push(e.data);};
  mediaRecorder.onstop=async()=>{
    $recState.textContent='rec: stopped';
    const blob=new Blob(chunks,{type:'video/webm'});
    $uploadState.textContent='uploading...';
    const up=await uploadToWixMedia(blob);
    log('[Upload]',up);
    $uploadState.textContent=up.ok?'ok':'fail';
  };
  mediaRecorder.start();
}

async function getRealtimeToken(){
  const r=await fetch('/_functions/realtimeToken',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uid:UID,companyId:COMPANY_ID,lang:LANG,voice:VOICE})});
  const j=await r.json();return j.client_secret;
}

async function connectRealtime(secret){
  pc=new RTCPeerConnection();
  pc.ontrack=ev=>{
    if(!remoteStream) remoteStream=new MediaStream();
    remoteStream.addTrack(ev.track);
    $remoteA.srcObject=remoteStream;
    $remoteA.play();
  };
  DC=pc.createDataChannel('oai-events');
  DC.onopen=()=>{log('[DC] open');primeSession();sendGreeting();};
  DC.onmessage=ev=>log('[GPT]',ev.data);
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  const offer=await pc.createOffer();await pc.setLocalDescription(offer);
  const r=await fetch('https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview',{method:'POST',headers:{Authorization:'Bearer '+secret,'Content-Type':'application/sdp'},body:offer.sdp});
  const ans={type:'answer',sdp:await r.text()};await pc.setRemoteDescription(ans);
}

function primeSession(){
  const L=LANG.startsWith('de')?'de':'en';
  DC.send(JSON.stringify({type:'session.update',session:{
    voice:VOICE,spoken_language:L,
    input_audio_transcription:{model:'whisper-1',language:L},
    instructions: makePrompt()
  }}));
}
function sendGreeting(){
  const txt=LANG.startsWith('de')
    ? "Willkommen zum Interview. Bitte stellen Sie sich kurz vor."
    : "Welcome to the interview. Please introduce yourself.";
  DC.send(JSON.stringify({type:'response.create',response:{conversation:'interview',instructions:txt,modalities:['audio']}}));
}
function makePrompt(){
  return LANG.startsWith('de')
    ? "Du bist der Interviewassistent. Stelle strukturierte Fragen auf Deutsch."
    : "You are the interview assistant. Ask structured questions in English.";
}

document.getElementById('btnStart').onclick=async()=>{
  await setupLocalMedia();
  const secret=await getRealtimeToken();
  await connectRealtime(secret);
  startRecording();
  $status.textContent='running';
};
document.getElementById('btnStop').onclick=()=>{mediaRecorder?.stop();pc?.close();};
</script>
</body>
</html>
