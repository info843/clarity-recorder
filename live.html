<!-- live.html (nur die nÃ¶tigen Anpassungen; restliche Basis bleibt) -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CLARITY Interview Live</title>
  <style>
    :root { --bg:#0b1020; --panel:#131a2e; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#e5e7eb;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:20px;display:grid;grid-template-columns:1fr 360px;gap:20px}
    .card{background:var(--panel);border-radius:14px;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    input,select,button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#e5e7eb}
    button{cursor:pointer}
    button.primary{background:#2563eb;border-color:#1e40af}
    textarea{min-height:110px;resize:vertical}
    #status{height:240px;overflow:auto;font-family:ui-monospace,Consolas,monospace;background:#0b1222;border:1px solid #1f2937;border-radius:10px;padding:10px}
    #video{width:100%;aspect-ratio:16/9;background:#000;border-radius:12px}
    audio{width:100%}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <div><label>UID</label><input id="uid" placeholder="IV-XXXX" /></div>
      <div><label>Company ID</label><input id="company" placeholder="NVL-02" /></div>
    </div>
    <div class="row" style="margin-top:10px">
      <div><label>Language</label><select id="lang"><option value="de">de</option><option value="en">en</option></select></div>
      <div><label>Voice</label><select id="voice"><option value="verse">verse</option><option value="alloy">alloy</option><option value="aria">aria</option></select></div>
    </div>
    <div class="row" style="margin-top:10px">
      <div><label>Token Endpoint</label><input id="tokenUrl" value="/api/wix-token-proxy" /></div>
      <div><label>Mux Upload API</label><input id="muxUrl" value="/api/mux-upload" /></div>
    </div>
    <div class="row" style="margin-top:14px">
      <button id="btnStart" class="primary">Start Live</button>
      <button id="btnStop">Stop</button>
    </div>
    <h4 style="margin:16px 0 6px">Status</h4>
    <div id="status"></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Agent Audio</h3>
    <audio id="agentAudio" controls></audio>
    <button id="btnUnlock" style="margin-top:8px">Audio entsperren</button>
    <h3 style="margin-top:16px">Preview (Your Camera)</h3>
    <video id="video" autoplay playsinline muted></video>
    <h3 style="margin-top:16px">Agent Text</h3>
    <textarea id="agentText" placeholder="Agent messagesâ€¦" readonly></textarea>
  </div>
</div>

<script>
const els = {
  uid:document.getElementById('uid'), company:document.getElementById('company'),
  lang:document.getElementById('lang'), voice:document.getElementById('voice'),
  tokenUrl:document.getElementById('tokenUrl'), muxUrl:document.getElementById('muxUrl'),
  btnStart:document.getElementById('btnStart'), btnStop:document.getElementById('btnStop'),
  btnUnlock:document.getElementById('btnUnlock'),
  status:document.getElementById('status'), audio:document.getElementById('agentAudio'),
  video:document.getElementById('video'), agentText:document.getElementById('agentText')
};
const log=(...a)=>{const t=new Date().toLocaleTimeString(); els.status.textContent+=`[${t}] ${a.join(' ')}\n`; els.status.scrollTop=els.status.scrollHeight; console.log(...a);};
(()=>{ const p=new URLSearchParams(location.search);
  if(p.get('uid')) els.uid.value=p.get('uid'); if(p.get('companyId')) els.company.value=p.get('companyId');
  if(p.get('lang')) els.lang.value=p.get('lang'); if(p.get('voice')) els.voice.value=p.get('voice');
  log('Token endpoint:', els.tokenUrl.value);
})();

let pc=null, dc=null, mediaStream=null, audioUnlocked=false, stopRecording=null;

els.btnUnlock.addEventListener('click', async () => {
  try { await els.audio.play(); audioUnlocked=true; log('Audio entsperrt'); } catch(e){ log('Audio entsperren fehlgeschlagen:', e?.message||e); }
});

els.btnStart.addEventListener('click', async ()=>{
  try{
    // Mic + Cam
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:true });
    els.video.srcObject = mediaStream;

    // Token holen
    const payload = { uid: els.uid.value, companyId: els.company.value, lang: els.lang.value, voice: els.voice.value };
    log('Fetching tokenâ€¦', JSON.stringify(payload));
    const r = await fetch(els.tokenUrl.value || '/api/wix-token-proxy', {
      method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload)
    });
    const j = await r.json().catch(()=> ({}));
    if(!r.ok || !j?.token) throw new Error(`TOKEN_BAD_RESPONSE status=${r.status} body=${JSON.stringify(j)}`);
    const token = j.token, model = j.model || 'gpt-4o-realtime-preview-2025-09-12';
    log('Token OK');

    // PeerConnection
    pc = new RTCPeerConnection();
    pc.onconnectionstatechange = () => log('pc:', pc.connectionState);
    pc.oniceconnectionstatechange = () => log('ice:', pc.iceConnectionState);

    // Mic senden + Agent-Audio empfangen (recvonly)
    const mic = mediaStream.getAudioTracks()[0];
    if (mic) pc.addTrack(mic, mediaStream);
    pc.addTransceiver('audio', { direction: 'recvonly' });

    const cam = mediaStream.getVideoTracks()[0];
    if (cam) pc.addTrack(cam, mediaStream);

    pc.ontrack = (ev)=>{
      log('ontrack kind=', ev.track?.kind, 'streams=', ev.streams?.length);
      if (ev.track.kind==='audio' && ev.streams?.[0]) {
        els.audio.srcObject = ev.streams[0];
        if (audioUnlocked) els.audio.play().catch(()=>{});
      }
    };

    // DataChannel: erste Ausgabe als Audio erzwingen
    dc = pc.createDataChannel('oai-events');
    dc.onopen = () => {
      log('DataChannel open');
      dc.send(JSON.stringify({
        type:'response.create',
        response:{
          instructions: els.lang.value==='de'
            ? 'Bitte begrÃ¼ÃŸe die Kandidatin/den Kandidaten freundlich und stelle eine erste kurze Warm-up-Frage.'
            : 'Please greet the candidate and ask a short warm-up question.',
          modalities:['audio','text'],
          voice: els.voice.value
        }
      }));
    };
    dc.onmessage = (e)=>{
      try{
        const msg = JSON.parse(e.data);
        if(msg?.type==='response.output_text.delta' && msg?.delta){
          els.agentText.value += msg.delta;
          els.agentText.scrollTop = els.agentText.scrollHeight;
        }
      }catch{}
    };

    // SDP Offer â†’ OpenAI (mit Beta-Header!)
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const rt = await fetch(`https://api.openai.com/v1/realtime?model=${encodeURIComponent(model)}`, {
      method:'POST',
      headers:{
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/sdp',
        'OpenAI-Beta': 'realtime=v1' // ðŸ”§ ohne das kommt hÃ¤ufig kein Audio zurÃ¼ck
      },
      body: offer.sdp
    });
    if(!rt.ok) throw new Error(`SDP_EXCHANGE_FAILED ${rt.status} ${await rt.text()}`);
    const answer = { type:'answer', sdp: await rt.text() };
    await pc.setRemoteDescription(answer);
    log('Realtime connected');

    // Optional: Mux aufnehmen wie zuvor
    try{
      const mr = new MediaRecorder(mediaStream, { mimeType:'video/webm;codecs=vp9,opus' });
      const chunks=[];
      mr.ondataavailable = e=> e.data && chunks.push(e.data);
      mr.onstop = async ()=>{
        try{
          const blob = new Blob(chunks, { type:'video/webm' });
          const fd = new FormData(); fd.append('file', blob, `clarity-interview-${Date.now()}.webm`);
          const up = await fetch(els.muxUrl.value, { method:'POST', body: fd });
          const uj = await up.json().catch(()=> ({}));
          if (up.ok) log('Mux upload OK, uploadId:', uj?.id || uj?.uploadId || 'n/a');
          else log('Mux upload failed', up.status, JSON.stringify(uj));
        } catch(e){ log('Mux upload error', e?.message||e); }
      };
      mr.start(1000);
      stopRecording = () => { try{ mr.stop(); }catch{} };
      log('MediaRecorder started (video+audio)');
    } catch(e){ log('MediaRecorder init failed:', e?.message||e); }

  }catch(e){
    log('ERROR:', e?.message || e);
    // AufrÃ¤umen
    try{ if(dc) dc.close(); }catch{}
    try{ if(pc) pc.close(); }catch{}
  }
});

els.btnStop.addEventListener('click', ()=>{
  try{ if(dc) dc.close(); }catch{}
  try{ if(pc) pc.close(); }catch{}
  pc=null; dc=null;
  if (mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
  if (typeof stopRecording==='function'){ try{ stopRecording(); }catch{} stopRecording=null; }
  log('Stopped');
});
</script>
</body>
</html>
