<!-- avatar.html – Glass Sphere + Atom Orbits (transparent) -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clarity Glass Avatar</title>
<style>
  :root{
    /* Größe & Look */
    --size: 320;                 /* px – kann per ?size=... überschrieben werden */
    --hue: 210;                  /* Grundfarbton des Scheins (wird per state geändert) */
    --level: 0;                  /* 0..1 – Lautstärke/Intensität */
    --speedBase: 14s;            /* Orbit-Grundtempo */
    --bg: transparent;
  }

  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    display:grid;place-items:center;
    font:14px/1.4 system-ui,Segoe UI,Roboto,Arial;
    color:#cbd5e1;
  }

  /* Container der Kugel */
  .sphere{
    width:min(calc(var(--size) * 1px),92vw);
    aspect-ratio:1/1;
    position:relative;
    isolation:isolate;           /* Glow bleibt „darunter“ */
  }

  /* Außenhalo (pulsierend) */
  .sphere::before{
    content:"";
    position:absolute; inset:-12%;
    border-radius:50%;
    background:
      radial-gradient(closest-side, hsla(var(--hue),90%,70%,.65), transparent 60%),
      radial-gradient(closest-side, hsla(calc(var(--hue) + 120),80%,60%,.45), transparent 62%),
      radial-gradient(closest-side, hsla(calc(var(--hue) + 240),75%,65%,.40), transparent 64%);
    filter:blur(22px);
    opacity:calc(.40 + var(--level)*.45);
    transform:scale(calc(1 + var(--level)*.25));
    transition:opacity .35s ease, transform .35s ease;
    animation:pulse 3.2s ease-in-out infinite;
  }
  @keyframes pulse { 0%,100%{transform:scale(calc(1 + var(--level)*.22))} 50%{transform:scale(calc(1.05 + var(--level)*.28))} }

  /* Das eigentliche SVG auf die volle Fläche */
  svg{position:absolute; inset:0; width:100%; height:100%; display:block}

  /* Orbits – weiche, leuchtende Linien */
  .orbit{
    fill:none; stroke-linecap:round; stroke-width:1.8;
    filter:drop-shadow(0 0 4px rgba(255,255,255,.35)) blur(.2px);
    opacity:calc(.70 + var(--level)*.25);
    mix-blend-mode:screen;
    transform-origin:50% 50%;
    animation:spin var(--speedBase) linear infinite;
    animation-duration:calc(var(--speedBase) - var(--level)*6s);
  }
  .o2{ animation-direction:reverse; animation-duration:calc(var(--speedBase)*.9 - var(--level)*5s) }
  .o3{ animation-duration:calc(var(--speedBase)*1.15 - var(--level)*4s) }

  @keyframes spin { to{ transform:rotate(360deg) } }

  /* Glas-Kugel – multipler Layer für Tiefen- & Glanzeffekte */
  .glass { filter: drop-shadow(0 10px 18px rgba(0,0,0,.35)); }
  .shine{
    mix-blend-mode:screen; opacity:.9;
    filter:blur(.2px);
  }
  .iris{
    opacity:.85; mix-blend-mode:screen;
    filter:blur(.3px);
  }
  .spec{
    mix-blend-mode:screen; opacity:.85; filter:blur(.2px);
  }

  /* optional: kleiner State-Badge (ausblendbar) */
  .badge{
    position:absolute; left:0; right:0; bottom:-26px;
    margin:auto; width:max-content; padding:4px 8px;
    font-size:12px; border-radius:999px;
    border:1px solid rgba(255,255,255,.15); background:rgba(0,0,0,.15);
    backdrop-filter:saturate(120%) blur(2px)
  }
</style>
</head>
<body>
  <div class="sphere" id="sphere">
    <!-- SVG: 0,0..100,100 -->
    <svg viewBox="0 0 100 100" aria-hidden="true">
      <defs>
        <!-- Glas-Grundverlauf -->
        <radialGradient id="g_glass" cx="34%" cy="28%" r="70%">
          <stop offset="0%"  stop-color="#ffffff" stop-opacity=".95"/>
          <stop offset="28%" stop-color="#dbeafe" stop-opacity=".85"/>
          <stop offset="60%" stop-color="#9ecff4" stop-opacity=".55"/>
          <stop offset="100%" stop-color="#7aa0c7" stop-opacity=".35"/>
        </radialGradient>

        <!-- irisierende Farben (Siri-like) -->
        <radialGradient id="g_iris" cx="50%" cy="50%" r="60%">
          <stop offset="0%"  stop-color="hsla(0,0%,100%,.95)"/>
          <stop offset="30%" stop-color="hsla(var(--hue), 85%, 65%, .55)"/>
          <stop offset="60%" stop-color="hsla(calc(var(--hue)+120), 80%, 55%, .45)"/>
          <stop offset="90%" stop-color="hsla(calc(var(--hue)+240), 80%, 65%, .35)"/>
          <stop offset="100%" stop-color="transparent"/>
        </radialGradient>

        <!-- Orbit-Farbverläufe -->
        <linearGradient id="lg1" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%"  stop-color="hsla(var(--hue), 90%, 75%, .85)"/>
          <stop offset="100%" stop-color="hsla(calc(var(--hue)+140), 90%, 60%, .85)"/>
        </linearGradient>
        <linearGradient id="lg2" x1="0%" y1="100%" x2="100%" y2="0%">
          <stop offset="0%"  stop-color="hsla(calc(var(--hue)+220), 90%, 70%, .9)"/>
          <stop offset="100%" stop-color="hsla(calc(var(--hue)+20),  90%, 70%, .9)"/>
        </linearGradient>
        <linearGradient id="lg3" x1="100%" y1="50%" x2="0%" y2="50%">
          <stop offset="0%"  stop-color="hsla(calc(var(--hue)+120), 85%, 60%, .9)"/>
          <stop offset="100%" stop-color="hsla(calc(var(--hue)+300), 85%, 65%, .9)"/>
        </linearGradient>

        <!-- weicher Rand für Glas -->
        <radialGradient id="g_edge" cx="50%" cy="50%" r="52%">
          <stop offset="80%" stop-color="rgba(255,255,255,.12)"/>
          <stop offset="100%" stop-color="rgba(255,255,255,.0)"/>
        </radialGradient>
      </defs>

      <!-- Außenglanz für Glasrand -->
      <circle class="glass" cx="50" cy="50" r="36" fill="url(#g_glass)"/>
      <circle cx="50" cy="50" r="36" fill="url(#g_edge)"/>

      <!-- Atom-„Kern“ -->
      <circle cx="50" cy="50" r="4.5"
              fill="white" opacity=".95"
              filter="drop-shadow(0 0 8px rgba(255,255,255,.75))"/>

      <!-- Irisierende Innenwolke -->
      <circle class="iris" cx="50" cy="50" r="28" fill="url(#g_iris)"/>

      <!-- Spekularlicht oben links -->
      <ellipse class="shine" cx="38" cy="34" rx="10.5" ry="7.5"
               fill="white" opacity=".85"
               filter="blur(1.2px)"/>

      <!-- Orbits (elliptisch + in 3 „Ebenen“ getiltet) -->
      <g style="transform:rotate(18deg) scaleY(.74)"><ellipse class="orbit o1" cx="50" cy="50" rx="27" ry="27" stroke="url(#lg1)"/></g>
      <g style="transform:rotate(-32deg) scaleY(.63)"><ellipse class="orbit o2" cx="50" cy="50" rx="23.5" ry="23.5" stroke="url(#lg2)"/></g>
      <g style="transform:rotate(58deg) scaleY(.55)"><ellipse class="orbit o3" cx="50" cy="50" rx="19.5" ry="19.5" stroke="url(#lg3)"/></g>

      <!-- dezenter innerer Schatten für Tiefe -->
      <circle cx="50" cy="56" r="30" fill="rgba(0,0,0,.10)" />
      <!-- Glasrand-Highlight unten rechts -->
      <ellipse class="spec" cx="62" cy="68" rx="14" ry="6"
               fill="rgba(255,255,255,.35)"/>
    </svg>

    <!-- optional: Badge (kann entfernt werden) -->
    <div id="badge" class="badge" hidden>idle</div>
  </div>

<script>
(() => {
  // Größe aus ?size=… übernehmen (optional)
  const qs = new URLSearchParams(location.search);
  const size = Number(qs.get('size'));
  if (!Number.isNaN(size) && size>120 && size<1200) {
    document.documentElement.style.setProperty('--size', size);
  }

  const badge = document.getElementById('badge');
  const root  = document.documentElement;

  function setState(s='idle'){
    // Farbstimmung + Halo-Tempo je nach State
    badge.hidden = false;
    badge.textContent = s;
    const map = {
      idle:      { hue:210, speed:'14s' },
      listening: { hue:160, speed:'12s' },
      thinking:  { hue:275, speed:'18s' },
      speaking:  { hue:200, speed:'9s'  }
    };
    const cfg = map[s] || map.idle;
    root.style.setProperty('--hue', cfg.hue);
    root.style.setProperty('--speedBase', cfg.speed);
  }
  function setLevel(x=0){
    const v = Math.max(0, Math.min(1, Number(x)||0));
    root.style.setProperty('--level', String(v));
  }

  // PostMessage API (kompatibel mit deinem alten Avatar)
  window.addEventListener('message', (ev) => {
    const d = ev?.data || {};
    if (d.type === 'avatar:set')   setState(d.state || 'idle');
    if (d.type === 'avatar:level') setLevel(d.value);
    if (d.type === 'ping') ev.source?.postMessage?.({ type:'avatar:ready' }, '*');
  });

  // Announce ready
  setTimeout(() => parent?.postMessage?.({ type:'avatar:ready' }, '*'), 30);
})();
</script>
</body>
</html>
